<!DOCTYPE html>
<html lang="lv">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ALT Teksta Pārbaudītājs</title>
    {# Izmantojam pareizo ceļu uz static failiem, izmantojot blueprint nosaukumu #}
    <link
      rel="stylesheet"
      href="{{ url_for('main.static', filename='style.css') }}"
    />
  </head>
  <body>
    <div class="container">
      <h1>ALT Teksta Pārbaudītājs</h1>
      <p class="description">
        Ievadiet tīmekļa lapas URL un izvēlieties ALT tekstu pārbaudes valodu.
        {% if config.ENABLE_VISION_API %} Papildus tiek veikta AI atslēgvārdu analīze{% if config.ENABLE_TRANSLATION_API and config.TARGET_TRANSLATION_LANGUAGE == 'lv'%} un tulkošana latviski{% endif %}.{% endif %}
      </p>
      <form method="POST" action="{{ url_for('main.index') }}" id="url-form">
        <div class="form-group">
           <label for="url">Tīmekļa lapas URL:</label>
           <input type="url" id="url" name="url" required value="{{ submitted_url }}" placeholder="piem., https://www.example.com" />
        </div>
        <div class="form-group">
           <label for="language">Pārbaudes valoda:</label>
           <select name="language" id="language">
             <option value="lv" {% if selected_language == 'lv' %}selected{% endif %}>Latviešu</option>
             <option value="en" {% if selected_language == 'en' %}selected{% endif %}>Angļu</option>
           </select>
        </div>
        <button type="submit" class="submit-button">Analizēt</button>
      </form>

      <div id="loading-indicator" class="loading-indicator" style="display: none">
        Notiek analīze, lūdzu uzgaidiet... ⏳
      </div>

      {% if error %}
      <div class="error-message">{{ error }}</div>
      {% endif %}

      {% if results is not none and not error %}
      <hr />
      <div class="results-summary">
        <h2>Analīzes Kopsavilkums (Valoda: {{ 'Latviešu' if selected_language == 'lv' else 'Angļu' }}):</h2>
        {% set total_images = results|length %}
        {% set issues_count = results | selectattr('suggestions', '>', []) | list | length %}
        {% set missing_alt_count = results | selectattr('analysis.exists', 'equalto', false) | list | length %}
        <p>Kopā atrasti attēli: <strong>{{ total_images }}</strong></p>
        <p>Attēli ar ieteikumiem: <strong>{{ issues_count }}</strong></p>
        <p>Attēli bez ALT atribūta: <strong>{{ missing_alt_count }}</strong></p>
      </div>

      <h2>Detalizēti Rezultāti:</h2>
      {% if results %}
      <ul class="results-list">
        {% for image in results %}
        {% set ai = image.analysis.ai_analysis or {} %} {# Nodrošina, ka ai vienmēr ir vārdnīca #}
        {% set ai_block_rendered = false %}
        {% set suggestions_rendered = image.suggestions|length > 0 %}
        <li>
          <img src="{{ image.src if image.src != 'Nezināms SRC' else url_for('main.static', filename='placeholder.png') }}"
               alt="Pārbaudāmā attēla sīktēls"
               loading="lazy"
               onerror="this.onerror=null; this.src='{{ url_for('main.static', filename='placeholder.png') }}'; this.alt='Neizdevās ielādēt sīktēlu'" />

          <div class="image-details">
            <strong>Attēls (src):</strong>
            {% if image.src != 'Nezināms SRC' %}
              <a href="{{ image.src }}" target="_blank" rel="noopener noreferrer">{{ image.src }}</a>
            {% else %}
              <span class="alt-missing">[SRC TRŪKST VAI NAV NORĀDĪTS]</span>
            {% endif %}
            <br />

            <strong>ALT teksts:</strong>
            {% if not image.analysis.exists %}
              <span class="alt-text-display alt-missing">[TRŪKST ALT ATRIBŪTA]</span>
            {% elif image.analysis.is_empty %}
              <span class="alt-text-display alt-empty">[TUKŠS (alt="")]</span>
            {% else %}
              <span class="alt-text-display">"{{ image.alt }}"</span>
            {% endif %}

            {# AI Analīzes Bloks #}
            {% if config.ENABLE_VISION_API and ai %}
              {% set ai_block_rendered = true %}
              <div class="ai-analysis-block
                {% if ai.error and 'Vision API' in ai.error %} ai-error
                {% elif ai.error %} ai-neutral {# Kļūda tulkošanā vai nav atslēgvārdu #}
                {% elif ai.labels_for_display and ai.total_compared_count > 0 and ai.matched_count == 0 %} ai-no-match
                {% elif ai.labels_for_display and ai.matched_count > 0 %} ai-match
                {% else %} ai-neutral {% endif %}">
                <strong>AI Analīze:</strong>
                {% if ai.error and 'Vision API' in ai.error %}
                  <span>Kļūda iegūstot atslēgvārdus: {{ ai.error }}</span>
                {% elif ai.error and 'AI neatpazina' in ai.error %}
                  <span>{{ ai.error }}</span>
                {% elif ai.get('labels_for_display') %}
                   <span>Atrastie atslēgvārdi
                      {% if ai.used_language == 'lv' %}(tulkoti LV):
                      {% elif ai.used_language == 'en' %}(oriģinālie EN):
                      {% else %}: {% endif %}
                    {% for label in ai.labels_for_display %}
                      <span class="ai-label-badge">{{ label }}</span>
                    {% endfor %}
                  </span><br>
                  <span>Sakritība ar Alt tekstu: <strong>{{ ai.matched_count }}</strong> no {{ ai.total_compared_count }}.</span>
                  {% if ai.translation_error %}
                    <br><span style="font-size: 0.9em; color: #dc3545;">Tulkošanas kļūda: {{ ai.translation_error }} (salīdzināts ar EN vārdiem).</span>
                  {% endif %}
                {% elif ai.error %} {# Cita veida kļūda, piem., tulkošanas #}
                   <span>AI analīzes kļūda: {{ ai.error }}</span>
                {% else %}
                  <span>AI analīze tika veikta, bet nav rezultātu.</span>
                {% endif %}
              </div>
            {% endif %}


            {# Ieteikumu Bloks #}
            {% if image.suggestions %}
              <ul class="suggestions">
                {% for suggestion in image.suggestions %}
                  <li>{{ suggestion }}</li>
                {% endfor %}
              </ul>
            {% endif %}

            {# OK statusu rādām tikai tad, ja nav ieteikumu UN (AI ir izslēgts VAI AI ir ieslēgts un nav kļūdu) #}
            {% if not suggestions_rendered and image.analysis.exists and not image.analysis.is_empty %}
                {% if not config.ENABLE_VISION_API %}
                     <span class="status-ok">Nav acīmredzamu problēmu.</span>
                {% elif ai_block_rendered and not ai.get('error') %}
                     <span class="status-ok">Nav acīmredzamu problēmu.</span>
                {% endif %}
            {% endif %}

          </div> {# end image-details #}
        </li>
        {% endfor %}
      </ul>
      {% else %}
        <p>Analīze pabeigta. Šajā lapā netika atrasti <code>&lt;img&gt;</code> tagi.</p>
      {% endif %}

      {% elif request.method == 'POST' and not error %}
        <p>Analīze pabeigta. Dotajā URL netika atrasti <code>&lt;img&gt;</code> tagi vai radās cita problēma.</p>
      {% endif %}

    </div> {# end container #}

    <script>
      const urlForm = document.getElementById("url-form");
      const loadingIndicator = document.getElementById("loading-indicator");
      const urlInput = document.getElementById("url");
      if (urlForm && loadingIndicator && urlInput) {
        urlForm.addEventListener("submit", function (event) {
          if (urlInput.value.trim() !== "") { loadingIndicator.style.display = "block"; }
          else { loadingIndicator.style.display = "none"; }
        });
      }
      window.addEventListener("pageshow", function (event) {
        if (loadingIndicator) { loadingIndicator.style.display = "none"; }
      });
    </script>
  </body>
</html>